name: Build, Test, and Deploy

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

jobs:
    build-and-test:
        name: Build and Test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                app: [web, api]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 20

            - name: Install dependencies
              working-directory: ${{ matrix.app }}
              run: npm install

            - name: Run tests
              working-directory: ${{ matrix.app }}
              run: npm test
    
    docker-build-and-push:
        name: Build and Push Docker Images
        needs: build-and-test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                app: [web, api]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to Azure Container Registry
              uses: azure/docker-login@v1
              with:
                login-server: ${{ secrets.ACR_LOGIN_SERVER }}
                username: ${{ secrets.ACR_USERNAME }}
                password: ${{ secrets.ACR_PASSWORD }}

            - name: Build Docker Image
              working-directory: ${{ matrix.app }}
              run: docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ matrix.app }}:${{ github.sha }} .

            - name: Push Docker Image
              run: docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ matrix.app }}:${{ github.sha }}

    deploy-to-azure:
        name: Deploy to Azure Web App
        needs: docker-build-and-push
        runs-on: ubuntu-latest
        strategy:
            matrix:
                app: [web, api]
        steps:
            - name: Deploy to Azure Web App
              uses: azure/webapps-deploy@v2
              with:
                app-name: ${{ secrets.AZURE_APP_NAME_${{ matrix.app | upper }} }}
                publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_${{ matrix.app | upper }} }}
                images: ${{ secrets.ACR_LOGIN_SERVER }}/${{ matrix.app }}:${{ github.sha }}